<!-- https://taxref.mnhn.fr/api/taxa/61098/status/lines -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Affichez statuts</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <h1 id="taxonName"></h1>
      <div class="card" style="width: 18rem">
        <div class="card-header">Liste de status</div>
        <ul id="listeStatuts" class="list-group list-group-flush"></ul>
      </div>
      <div class="card" style="width: 18rem">
        <div class="card-header">Liste de status</div>
        <ul id="taxonList" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"
  ></script>
  <script src="js/status.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/media.js"></script>
  <script src="js/taxon.js"></script>
  <script>
    wkt =
      "POLYGON ((3.6067457860489474 44.31735648705861, 3.6067235753826665 44.31753222361296, 3.606654037712057 44.31770147249114, 3.606539844959545 44.31785772946521, 3.606385385237379 44.31799498953319, 3.6061965942531686 44.318107977708294, 3.60598072721813 44.31819235175796, 3.605746080021263 44.3182448690979, 3.605501670386475 44.31826351142357, 3.6052568912711283 44.3182475622866, 3.605021149834159 44.31819763463273, 3.6048035058580408 44.31811564724215, 3.6046123235298966 44.318004750978425, 3.604454949972245 44.31786920768214, 3.6043374328830575 44.31771422636648, 3.6042642881382485 44.317545763013385, 3.6042383262856137 44.317370291667636, 3.6042605445924387 44.31719455562893, 3.604330088786867 44.317025308305304, 3.6044442859532793 44.31686905368802, 3.6045987473074517 44.31673179642029, 3.604787536893315 44.31661881106261, 3.60500339971254 44.31653443941854, 3.605238040517946 44.3164819237062, 3.6054824425586673 44.31646328198232, 3.6057272140334704 44.316479230603655, 3.605962948946621 44.316529156702984, 3.606180588508839 44.31661114173676, 3.606371769204977 44.31672203520022, 3.6065291441609757 44.316857575679116, 3.6066466654659757 44.31701255458916, 3.6067198166022463 44.31718101631465, 3.6067457860489474 44.31735648705861))";
    const limit = 300;
    const taxonData = {
      "Capra Ibex": {
        name: "Capra Ibex",
        cd_ref: 61098,
        gbifId: 2441055,
        count: 125,
      },
    };

    function completeData(taxonsData, taxonKey) {
      // return getMedias(taxonsData[taxonKey].gbifId).then((mediaUrl) => {
      //   taxonsData[taxonKey]["mediaUrl"] = mediaUrl;
      // });
      return getTaxRefCdNom(taxonsData[taxonKey].gbifId)
        .then((taxrefId) => {
          // get cd_ref
          if (taxrefId) {
            taxonsData[taxonKey]["cd_ref"] = taxrefId;
            getStatusForATaxon(taxonsData[taxonKey]).then((statusData) => {
              // use cd_ref to get status of the taxon
              taxonsData[taxonKey]["status"] = statusData;
            });
          }
        })
        .then(function () {
          getMedias(taxonsData[taxonKey].gbifId).then((mediaUrl) => {
            taxonsData[taxonKey]["mediaUrl"] = mediaUrl;
          });
        });
    }
    speciesList = {};
    // Get Taxon list
    getGbifTaxon(wkt, limit)
      .then((taxonsData) => {
        let data = [];
        Object.keys(taxonsData).forEach((value) => {
          data.push([value, taxonsData[value]["occCount"]]);
        });
        data.sort(function (a, b) {
          return b[1] - a[1];
        });
        data = data.slice(0, 10).map((x) => {
          return x[0];
        });
        let newTaxonsData = {};
        data.forEach((key) => {
          newTaxonsData[key] = taxonsData[key];
        });
        return newTaxonsData;
      })
      .then(async function (taxonsData) {
        console.log("taxonsData", taxonsData);
        // Loop on each taxon
        let promises = [];
        Object.keys(taxonsData).forEach((taxonKey) => {
          promises.push(completeData(taxonsData, taxonKey));
        });
        await Promise.all(promises);
        console.log("taxonsData", taxonsData);
        return taxonsData;
      })
      .then((taxonList) => {
        console.log(taxonList);
      });

    // getTaxRefCdNom(taxonData["Capra Ibex"].gbifId).then(function (res) {
    //     console.log(res);
    // });
    //   const listeStatusUl = document.getElementById("listeStatuts");
    //   document.getElementById("taxonName").innerHTML =
    //     taxonData["Capra Ibex"].name;

    console.log(speciesList);
    // speciesList.forEach(species => {
    // getStatusForATaxon(taxonData["Capra Ibex"]).then(function (res) {
    //   res.status.forEach((element) => {
    //     const statusTypeAvailable = Object.keys(labels);
    //     statusTypeAvailable.forEach(function (statusType) {
    //       // if no data available for this status Type
    //       if (!element[statusType]) {
    //         return;
    //       }
    //       var li = document.createElement("li");
    //       li.classList.add("list-group-item");
    //       li.innerHTML = `<span class="badge bg-primary rounded-pill">${labels[statusType]}</span><span>${element[statusType]}</span>`;

    //       listeStatusUl.appendChild(li);
    //     });
    //   });
    // });
    // });
  </script>
</html>
