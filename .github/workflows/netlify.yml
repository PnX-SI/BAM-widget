name: Deploy website
on:
    pull_request_review_comment:
        types: [created]
    issue_comment:
        types: [created]

permissions:
    contents: read
    pull-requests: write
    issues: write
    repository-projects: read

jobs:
    check-permissions:
        runs-on: ubuntu-latest
        # Vérifie que c'est bien sur une PR
        if: github.event.issue.pull_request || github.event.pull_request
        outputs:
            is-admin: ${{ steps.check-admin.outputs.is-admin }}
            should-deploy: ${{ steps.check-comment.outputs.should-deploy }}

        steps:
            - name: Check comment content
              id: check-comment
              run: |
                  COMMENT_BODY="${{ github.event.comment.body }}"
                  if [[ "$COMMENT_BODY" == *"/deploy"* ]]; then
                    echo "should-deploy=true" >> $GITHUB_OUTPUT
                  else
                    echo "should-deploy=false" >> $GITHUB_OUTPUT
                  fi

            - name: Check if user is admin
              id: check-admin
              if: steps.check-comment.outputs.should-deploy == 'true'
              uses: actions/github-script@v7
              with:
                  result-encoding: string
                  script: |
                      try {
                        const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          username: context.payload.comment.user.login
                        });
                        
                        const isAdmin = permission.permission === 'admin';
                        console.log(`User ${context.payload.comment.user.login} has ${permission.permission} permission`);
                        
                        if (!isAdmin) {
                          await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: context.issue.number,
                            body: '❌ Vous devez être admin du repository pour déclencher un déploiement.'
                          });
                        }
                        
                        return isAdmin.toString();
                      } catch (error) {
                        console.error('Error checking permissions:', error);
                        return 'false';
                      }

    build-and-deploy:
        needs: check-permissions
        if: |
            needs.check-permissions.outputs.is-admin == 'true' &&
            needs.check-permissions.outputs.should-deploy == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Add reaction to comment
              uses: peter-evans/create-or-update-comment@v4
              with:
                  comment-id: ${{ github.event.comment.id }}
                  reactions: rocket

            - name: Get PR branch
              uses: xt0rted/pull-request-comment-branch@v2
              id: comment-branch

            - name: Repository Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.comment-branch.outputs.head_ref }}

            - name: Setup NodeJS
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"

            - name: Install Netlify
              run: npm install netlify-cli@17.10.1 -g

            - name: Install Dependencies
              run: npm ci

            - name: Build project
              run: npm run build

            - name: Deploy to Netlify
              id: netlify_deploy
              run: |
                  netlify deploy \
                    --dir dist \
                    --site ${{ secrets.NETLIFY_SITE_ID }} \
                    --auth ${{ secrets.NETLIFY_API_TOKEN }} \
                    --prod

            - name: Comment deployment success
              if: success()
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-number: ${{ github.event.issue.number }}
                  body: |
                      ✅ Déploiement réussi !

                      Le site a été déployé sur Netlify.

            - name: Comment deployment failure
              if: failure()
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-number: ${{ github.event.issue.number }}
                  body: |
                      ❌ Le déploiement a échoué.

                      Vérifiez les logs pour plus de détails.
